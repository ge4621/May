<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="chartMapper">

	<resultMap type="schedule" id="resultCategory">
		<result column="cnt" property="cnt" />
		<result column="category_no" property="categoryNo" />
	</resultMap>
	
	<select id="selectMonthSchedule" resultType="int">
		select count(*)
		from schedule
		where user_no = #{userNo}
		and start_date &lt;= LAST_DAY(TO_DATE(#{dashBoard.currentMonth},'YYYY-MM'))
		and (
			end_date is null
			or end_date &gt;= TRUNC(TO_DATE(#{dashBoard.currentMonth},'YYYY-MM'),'MM')
		)
	</select>
	
	<select id="selectCategoryCnt" resultMap="resultCategory">
	select cnt,category_no
	from(
		select count(*) as cnt , category_no , rank() over(order by count(*) desc) as rnk
		from schedule
		where user_no = #{userNo}
		and start_date &lt;= LAST_DAY(TO_DATE(#{dashBoard.currentMonth},'YYYY-MM'))
		and (
			end_date is null
			or end_date &gt;= TRUNC(TO_DATE(#{dashBoard.currentMonth},'YYYY-MM'),'MM')
		)
		group by category_no
	)
	where rnk = 1
	</select>
</mapper> 